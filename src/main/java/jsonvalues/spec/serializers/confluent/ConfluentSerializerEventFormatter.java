package jsonvalues.spec.serializers.confluent;

import static jsonvalues.spec.AvroSpecFun.formatTime;

import java.time.ZoneOffset;
import java.time.format.DateTimeFormatter;
import java.util.function.Function;
import jdk.jfr.consumer.RecordedEvent;

/**
 * A function that takes the Java Flight Recorder (JFR) events generated by the Confluent Avro serializer and returns a
 * formatted string representation of the event. The formatted string includes the result, topic, duration,
 * number of bytes, operation counter, and event start time.
 */
public final class ConfluentSerializerEventFormatter implements Function<RecordedEvent, String> {

  /**
   * The singleton instance of {@code ConfluentSerializerEventFormatter}.
   */
  public final static ConfluentSerializerEventFormatter INSTANCE = new ConfluentSerializerEventFormatter();

  ConfluentSerializerEventFormatter() {
  }

  @SuppressWarnings("InlineFormatString")
  private static final String FORMAT_SUC =
      "event:confluent-serializer; result: %s; topic: %s; duration: %s; bytes: %s; counter: %s; start_time: %s";

  @SuppressWarnings("InlineFormatString")
  private static final String FORMAT_ERR =
      "event:confluent-serializer; result: %s; exception: %s; topic: %s; duration: %s; bytes: %s; counter: %s; start_time: %s";

  static final String EVENT_NAME = "Confluent_Avro_Serializer_Event";


  @Override
  public String apply(final RecordedEvent event) {
    assert EVENT_NAME.equals(event.getEventType()
                                  .getName());
    var result = event.getValue("result");
    var topic = event.getValue("topic");
    boolean isSuccess = "SUCCESS".equals(result);
    return isSuccess ?
           String.format(FORMAT_SUC,
                         result,
                         topic,
                         formatTime(event.getDuration()
                                         .toNanos()),

                         event.getValue("bytes"),
                         event.getValue("counter"),
                         event.getStartTime()
                              .atZone(ZoneOffset.UTC)
                              .format(DateTimeFormatter.ISO_OFFSET_DATE_TIME)
                        ) :
           String.format(FORMAT_ERR,
                         result,
                         event.getValue("exception"),
                         topic,
                         formatTime(event.getDuration()
                                         .toNanos()),
                         event.getValue("bytes"),
                         event.getValue("counter"),
                         event.getStartTime()
                              .atZone(ZoneOffset.UTC)
                              .format(DateTimeFormatter.ISO_OFFSET_DATE_TIME)
                        );

  }
}
